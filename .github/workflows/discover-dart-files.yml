name: Discover Dart Files

on:
  push:
    branches: [ main, dev ]  # Trigger auf main und dev
  pull_request:
    branches: [ main, dev ]  # Trigger auf main und dev
  workflow_dispatch:  # Ermöglicht manuellen Trigger über GitHub UI

jobs:
  discover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch alle Branches/Commits für vollständigen Tree

      - name: Generate Tree Structure for *.dart Files
        id: tree
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          path: .
          exclude: "node_modules|dist|.git|build|.dart_tool|*.lock"  # Typische Dart/Flutter-Ausschlüsse
          depth: 99  # Vollständig rekursiv
          tree_filter: "*.dart"  # Nur .dart-Dateien filtern

      - name: Output Tree Structure
        run: |
          echo "=== VERZEICHNISBAUM DER *.DART-DATEIEN ==="
          tree_output="${{ steps.tree.outputs.content }}"
          echo "$tree_output" | grep "\.dart$" || echo "Keine *.dart-Dateien gefunden."
          echo ""  # Leerzeile

      - name: List and Output *.dart Files Content in Markdown
        run: |
          # Alle .dart rekursiv finden (relativ)
          dart_files=$(find . -type f -name "*.dart" | sort)
          
          if [ -z "$dart_files" ]; then
            echo "Keine *.dart-Dateien gefunden."
            exit 0
          fi
          
          # Markdown-Datei erstellen
          mkdir -p docs/project
          {
            echo "# Flutter App Dateistruktur"
            echo ""
            echo "## Verzeichnisbaum der *.dart-Dateien"
            echo ""
            echo "```"
            for file in $dart_files; do
              rel_path="${file#./}"  # Relativ machen
              echo "├── $rel_path"
            done
            echo "```"
            echo ""
            echo "## Inhalt der *.dart-Dateien"
            for file in $dart_files; do
              rel_path="${file#./}"
              echo ""
              echo "### Inhalt von \`$rel_path\`"
              echo "```dart"
              cat "$file" || echo "Fehler beim Lesen von $rel_path"
              echo "```"
            done
          } > docs/project/flutter-app-fs.md
          
          # Inhalt auch in Logs ausgeben
          cat docs/project/flutter-app-fs.md

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/project/flutter-app-fs.md
          git commit -m "Update docs/project/flutter-app-fs.md with latest Dart file structure" || echo "Keine Änderungen zu committen"
          git push origin HEAD
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Output as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dart-files-discovery
          path: docs/project/flutter-app-fs.md